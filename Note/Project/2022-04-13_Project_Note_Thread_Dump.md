# Project Note : Thread Dump

thread dump 의 수집 / 분석 방법 들에 대해 조사한 내용입니다. 



> [thread dump 얻는 8가지 방법](https://blog.fastthread.io/2016/06/06/how-to-take-thread-dumps-7-options/)
[Get All Running JVM Threads](https://www.baeldung.com/java-get-all-threads) 
[How to Analyze Java Thread Dumps](https://www.baeldung.com/java-analyze-thread-dumps)
[Creating and Analyzing Thread Dumps](https://reflectoring.io/analyzing-thread-dumps/)

## **Thread Dump ?**

스레드 덤프는 CPU 스파이크, 교착 상태, 응답 시간 저하, 메모리 문제, 응답하지 않는 응용 프로그램 및 기타 시스템 문제를 진단하는 데 중요한 아티팩트입니다.문제를 분석하고 찾아낼 수 있는 [http://fastthread.io/](http://fastthread.io/) 와 같은 훌륭한 온라인 스레드 덤프 분석 도구 가 있습니다. 그러나 이러한 도구에는 적절한 스레드 덤프를 입력으로 제공해야 합니다.

### 수집 방법

- jstack
- Linux : kill -3
- Java VisualVM
- JMC(Java Mission Control)
- ThreadMXBean
  
    Java VisualVM 도 결국 내부적으로 이를 이용한다. 
    
    > **Taking a Thread Dump Programmatically using JMX**
    [ThreadMXBean](https://docs.oracle.com/en/java/javase/11/docs/api/java.management/java/lang/management/ThreadMXBean.html) is the management interface for the thread system in the Java Virtual Machine. Using this interface also you can generate thread dumps.
    > 
    
    > **MBean을 이용한 더 자세한 정보 획득하기**
    MBean을 이용하면 ThreadInfo 객체를 획득할 수 있으며, ThreadInfo 객체를 이용하면 스레드 덤프에서 얻기 힘든 정보들을 추가로 얻을 수 있다. 예를 들어, ThreadInfo 객체의 메서드를 이용해 스레드가 BLOCKED 상태나 WAIT 상태로 된 시간의 정보를 얻을 수 있고, 이를 이용해 비정상적으로 긴 시간 동안 동작하고 있지 않은 스레드 목록을 얻을 수도 있다.
    
    > JMX(Java Management eXtensions)는 응용 프로그램(소프트웨어)/객체/장치 (프린터 등) 및 서비스 지향 네트워크 등을 감시 관리를 위한 도구를 제공하는 자바 API이다.
    응용 프로그램(소프트웨어)/객체/장치, 서비스 지향 네트워크는 MBean(Managed Bean)이라는 객체로 표현된다.
    
- JCMD
- APM tools
  
    **Application Performance Monitoring (APM) Tools**: Few APM tools provide options to generate thread dumps. For example, [AppDynamics](https://docs.appdynamics.com/display/PRO21/Diagnostic+Actions) provides this capability as part of its diagnostic actions, by directing its **Java agent** to take a thread dump for a specified number of samples with each sample lasting for a specified number of milliseconds. The thread dump is executed on the node monitored by the agent.
    

> [Threading and the Java Agent](https://docs.appdynamics.com/4.5.x/en/application-monitoring/install-app-server-agents/java-agent/threading-and-the-java-agent)
A pivotal part of the functionality of the Java agent is tracing activity within the JVM such that all the activity (both internal and external to the JVM) that results from servicing any given inbound request can be associated with the request itself. In simple cases, each request is processed by one Java thread, making it only necessary to track the processing of that single thread, in a pattern widely known as 'thread per request'.
> 

Thread API 

- *`Thread`* 클래스 의 *`getAllStackTrace()`* 메서드는 실행 중인 모든 스레드의 스택 추적을 제공합니다. 키가 *Thread 개체인 Map* 을 반환 하므로 키 집합을 얻고 해당 요소를 반복하여 스레드에 대한 정보를 얻을 수 있습니다.
- `Thread.getAllStackTraces().keySet()`은 응용 프로그램 스레드와 시스템 스레드를 포함한 모든 `Thread` 를 반환합니다.

### **분석**

**Online**

- fastthread [https://fastthread.io/](https://fastthread.io/)
    - 결과 예시 [https://fastthread.io/ft-thread-report.jsp?dumpId=1&s=t](https://fastthread.io/ft-thread-report.jsp?dumpId=1&s=t)
    - 앱 분석 예시 [https://tech.kakao.com/2020/06/15/websocket-part2/](https://tech.kakao.com/2020/06/15/websocket-part2/)
    
    > We parse multiple thread dump formats. But still we keep uncovering new formats of thread dumps
    > 
- jstack review [https://jstack.review/#tda_1_dump](https://jstack.review/#tda_1_dump)
- spotify open source [https://spotify.github.io/threaddump-analyzer/](https://spotify.github.io/threaddump-analyzer/)
    - This tool will parse thread dumps generated by Java's `jstack` utility, or generated by sending a `SIGQUIT` to the JVM

**StandAlone**

- JProfiler
- IBM Thread Monitor and Dump Analyzer for Java (TMDA)
- Irockel Thread Dump Analyser (TDA)

기타 참고 자료 

> [JAVA 스레드 덤프와 VisualVM](https://bestugi.tistory.com/38)